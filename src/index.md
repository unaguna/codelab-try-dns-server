author: KOIZUMI Yusuke
summary: 仮想マシン上でDNSサーバを立ち上げて、LAN内向けに名前解決を提供します
id: try-dns-server
categories: named
environments: Web
status: Publish
Feedback Link: /


# 自宅 DNS サーバの立ち上げとレコード登録

## はじめに
Duration: 0:05:00

このハンズオンでは、次の手順で DNS サーバを構築します。

1. Oracle VirtualBox の仮想マシンに AlmaLinux (CentOS の後継) をインストールします。
2. named を設定して DNS サーバとして利用可能にします。
3. 特定のドメインについての名前解決を提供します。


### 環境

以下の環境・前提条件でハンズオンを記載します。自身の状況と異なる部分は適宜読み替えてください。

- ホストOS: Windows 10
- ホスト側のマシンの仮想環境: Oracle VirtualBox 7.0
- ゲストOS: AlmaLinux 9

### 前提条件

- IP アドレスとネットワークについて知識があること。とくに
    - `192.168.0.0/20` と `192.168.0.0/24` の違いを理解していること
- 名前解決を知っていることとくに
    - `https://www.google.com/` にアクセスする際、ドメイン名 (`www.google.com`) とIPアドレスの紐づけが必要であることを理解していること
    - 上記の紐づけを担うサーバの名称を知っていること

### 具体的な設定値

以下の環境・前提条件でハンズオンを記載します。自身の状況と異なる部分は適宜読み替えてください。

- Windows 10 のマシンが属するネットワークは `192.168.0.0/24` である
- DNS サーバを `192.168.0.101` に設置する
    - あなたが `192.168.0.0/24` の管理者でない場合、これができない可能性があります。
- ホスト側は `192.168.0.1` をデフォルトゲートウェイとしていて、仮想マシン側も同様に設定する。
- DNS サーバで `myserver.test` を `192.168.0.10` に解決する

<aside class="negative">
これらの設定値はネットワークの都合に合わせて適宜変更してください。
</aside>

## 仮想マシンの準備

このハンズオンでは DNS サーバを仮想マシン上に立ち上げます。そのため、まずは仮想マシンを用意しましょう。

### Oracle VirtualBox のインストール

このハンズオンでは仮想環境として Oracle VirtualBox を使用するため、そのインストールをします。

<aside class="positive">

すでに Oracle VirtualBox がインストールされている場合、この手順は不要です。
</aside>

[ダウンロードページ](https://www.virtualbox.org/wiki/Downloads)からインストーラをダウンロードできます。このハンズオンでは Windows 10 を使用している前提なので、このページの「Windows hosts」をクリックします。

インストーラーをダウンロード出来たら、そのインストーラー を使用して Oracle VirtualBox をインストールしましょう。

<aside class="positive">
ダウンロードページで拡張パックもダウンロードすることができますが、このハンズオンでは拡張パックは不要です。
</aside>

### AlmaLinux の入手

仮想マシンにインストールするOSのインストールディスクイメージを取得しましょう。

[ダウンロードページ](https://almalinux.org/ja/get-almalinux/)へアクセスします。いくつかダウンロードリンクがありますが、今回は AlmaLinux OS 9 の DVD ISO をクリックしてダウンロードします。

<aside class="positive">
サイズが大きいため時間がかかり、ネットワークが不安定な場合には失敗する確率が上がります。Torrent を使用できる場合は「.torrent ファイルをダウンロード」から入手してもかまいません。
</aside>

<aside class="negative">
Minimal ISO の方が軽く仮想マシンのディスクも小さくできますが、この ISO では最小限のインストールしかできないため、問題が発生した際の調査には Linux の専門性が必要です。また OS インストール時に DNS サーバをインストールできないため、別途インストール作業が必要となります。

一方で DVD ISO であれば GUI 付き、サーバ管理のための一連のツール付きで OS をインストールできるため、Linux のコマンドに精通していなくともこのハンズオンを進めることができます。
</aside>

### 仮想マシンの作成

Oracle VirtualBox をインストール出来たら、仮想マシンを作成しましょう。まずはあとで AlmaLinux をインストールするための空のマシンを作成します。

Oracle VirtualBox のメニューから『仮想マシン』→『新規』をクリックします（下図）。

![新規](./img/virtualbox-menu-create.png)

下図のウィンドウが開くため、下記の点を入力します。

- 名前は何でもよいですが、ここでは「DNS-server」としています。
- フォルダは、容量不足等の理由がなければ変更しなくて構いません。
- ISO イメージには先ほど入手した AlmaLinux のインストールディスクイメージを指定します。
- 「自動インストールをスキップ」にチェックを入れます。
    - 執筆時点で AlmaLinux 9 の自動インストールに失敗するため

![仮想マシンの作成ダイアログ](./img/virtualbox-create-dialog.png)

「次へ」をクリックします。その後の『ハードウェア』や『仮想ハードディスク』の設定は変更せず「次へ」をクリックしてかまいません。

ひととおり設定を選ぶと『概要』が表示されます。内容に問題が無ければ右下の「完了」をクリックすることで、仮想マシンを実際に作成します。

作成されると下図のように仮想マシン一覧に表示されます。

![](./img/virtualbox-created.png)

### ネットワーク設定の変更

仮想マシンが実際のネットワークに接続する方式（もしくは仮想のネットワークに接続する方式）はいくつかあります。

今回は仮想マシンにはホスト側と同じネットワークに参加させてそのIPアドレスを割り当てようとしているので、それができるように仮想マシンのネットワーク設定を変更しましょう。

先ほど表示された画面の「設定」（下図）をクリックすることで、先ほど作成した仮想マシンの設定ダイアログを開きます。

![設定ボタンの位置](./img/virtualbox-created-option.png)

設定ダイアログが開いたら、その左側のメニューの「ネットワーク」をクリックしましょう。下図の画面が表示されます。

![ネットワーク画面](./img/virtualbox-option-network.png)

ここで次のように変更します。

- 割り当てを「ブリッジアダプター」に変更します。
- 名前を確認します。今回はホスト側と仮想マシンの両方を 192.168.0.0/24 に参加させる予定なので、ホストが 192.168.0.0/24 に参加するために使用しているネットワークカードが選択されていればOKです。

上記のように変更したら「OK」をクリックして設定を確定しましょう。

### 次のステップへ

これで、空っぽの仮想マシンを準備できました。次のステップではこの仮想マシンに OS をインストールします。

## 仮想マシンへのOSインストール

このステップでは、前のステップで作成した空の仮想マシンへOSをインストールします。

### インストーラーの起動

まず、前回作成した仮想マシンを起動しましょう。下図で示すボタンをクリックしてください。仮想マシンが起動するので少し待ちましょう。

![起動ボタンの位置](./img/virtualbox-created-run.png)

少し待つと下図の画面が表示されます。

<aside class="pisitive">

仮想マシンのウィンドウをクリックすると、マウスやキーボード入力が仮想マシンへ入力される状態になります。解除するためには、右の Ctrl キーを押しましょう。
</aside>

![インストールディスクの初期画面](./img/virtualmachine-disk-top.png)

「Test this media & instal AlmaLinux」が選択されているので Enter キーを入力しましょう。あるいは、何も入力せずに1分待っても同じように先へ進めます。

下図のように文字列が表示され、ディスクのチェックが始まります。そのまま待ちましょう。

![ディスクチェック中の画面](./img/virtualmachine-diskcheck.png)

チェックが終わるとさらに文字列が表示された後、下図の画面が表示されます。

![インストーラの初期画面](./img/virtualmachine-installer-top.png)

### 言語の選択

まずインストーラが使用する言語を指定します。問題が無ければこのまま右下の「続行」をクリックします。

少し待つと、下図の画面が表示されます。

![インストーラのメイン画面](./img/virtualmachine-installer-main.png)

### ユーザの作成

最低限1つのユーザを作成する必要があります。「ユーザの作成」をクリックすると下図の画面が表示されるため、下記のように設定します。

- フルネームとユーザ名は、ここでは admin としました。
- 「このユーザを管理者にする」にチェックを入れます。最低限、1つの管理者ユーザかルートユーザが必要です。
- 「このアカウントを使用する場合にパスワードを要求する」にチェックを入れます。要求しなくてもDNSサーバを構築できますが、セキュリティ事故を防ぐためパスワードを要求するようにします。
- パスワード欄には、このユーザのログインに使用するパスワードを入力します。

![インストーラのユーザ設定画面](./img/virtualmachine-installer-user.png)

入力したら、左上の「完了」をクリックすることで前の画面に戻ります。

### パーティションの設定

「インストール先」にも赤色のメッセージが表示されているため操作が必要ですが、仮想マシンへインストールする際は、通常、設定変更の必要がありません。そのため、次の手順を実施して赤字のメッセージを解消するだけで問題ありません。

1. 「インストール先」をクリックすることで、インストール先の設定画面へ移動する。
2. 左上の「完了」をクリックすることで、前の画面に戻る。
3. 少し待ち、「インストール先」に表示されていた赤字のメッセージが消え、新たに赤字のメッセージが表示されないことを確認する。

### ソフトウェアの選択

次にOSとともにインストールするソフトウェアを選択します。「ソフトウェアの選択」をクリックすると、下図のような画面が表示されます。次のように設定します。

- 左の一覧の「サーバー (GUI 使用)」をクリックします
- 右の一覧の「DNS ネームサーバー」にチェックを付けます。

![インストーラのソフトウェア選択画面](./img/virtualmachine-installer-software.png)

入力したら、左上の「完了」をクリックすることで前の画面に戻ります。

<aside class="negative">
ここで「サーバー」を選んでもハンズオンを進めることはできますが、問題が起きたときはコマンドでの調査・解決が必要になるため Linux マシンの管理に精通していない場合はお勧めしません。GUI 使用のインストールをお勧めします。
</aside>

### ネットワークの設定

次に、ゲストOSのネットワークを設定します (物理層にあたる部分は仮想マシンの設定として設定済みですが、ここでは論理的な部分を設定します)。「ネットワークとホスト名」をクリックすると、下図のような画面が表示されます。

![インストーラのネットワーク設定画面](./img/virtualmachine-installer-network1.png)

右下の「設定」ボタンをクリックすると、下図のような画面が表示されます。

![インストーラのネットワーク設定編集画面](./img/virtualmachine-installer-network2.png)

「IPv4 設定」をクリックすると、下図のような画面が表示されます。下記のように設定します。

- メソッドを「手動」にします
- アドレスの「追加」ボタンをクリックし、入力欄に「192.168.0.101」(DNS サーバに割り当てるIPアドレス)、「24」、「192.168.0.1」を入力します。
- DNS サーバーはここでは 8.8.8.8 としました。

<aside class="negative">
ここでの設定値はネットワークの都合に合わせて適宜変更してください。
</aside>

![インストーラのネットワーク設定編集画面](./img/virtualmachine-installer-network3.png)

入力したら、右下の「保存」をクリックし、左上の「完了」をクリックすることで前の画面に戻ります。

### インストールの開始

ここまでの設定がすべて完了したら、実際にインストールを開始しましょう。下図の画面の右下の「インストールの開始」ボタンをクリックすることで、インストールが始まります。

![インストーラ](./img/virtualmachine-installer-main2.png)

しばらく待つとインストールが完了して下図のような画面になります。

![インストーラ](./img/virtualmachine-installer-completed.png)

右下の「システムの再起動」ボタンをクリックしましょう。仮想マシンが再起動し、インストールしたOSが起動します。

### ネットワーク接続の確認

OSが起動すると下図の画面が表示されます。

![ログイン画面](./img/virtualmachine-almalinux-login.png)

この状態で、ホスト側 (もしくは他の端末) の Powershell で次のコマンドを実行することで、仮想マシンとの疎通を確認しましょう。

```powershell
ping 192.168.0.101
```

192.168.0.101 からの応答があれば成功です。応答がない場合、仮想マシンかゲストOS (AlmaLinux) のネットワーク設定が誤っている可能性があります。下記の手順で見直してください。

1. 仮想マシンの現在のネットワーク設定は、設定時の手順をたどることで確認・変更することができます。
2. ゲスト OS のネットワーク設定は、ログイン画面でログインした後、右上の ![ネットワークアイコン](./img/icon-almalinux-network.png) から確認・変更することができます。


## DNS サーバ立ち上げ

### 名前解決できるかを確認する

DNS サーバを設定したので、実際に名前解決ができるかを確認しましょう。ホスト側 (あるいは同一ネットワーク内の別の端末) で Powershell を起動し、下記のコマンドを実行します。

```powershell
nslookup google.com 192.168.0.101
```

IPアドレスが表示されれば成功です。

成功しない場合、以下の可能性があります。

- DNS サーバ (仮想マシン) へ到達できない
    - 下記のコマンドで IP 層レベルで疎通していることを確かめましょう。

        ```console
        ping 192.168.0.101
        ```

    - 疎通していない場合、次の点を確認しましょう。

        - DNS サーバを設置した仮想マシンのネットワーク設定が「ブリッジアダプター」であり有効になっていること
        - DNS サーバを設置した AlmaLinux のネットワーク設定で、IPv4 のアドレスが 192.168.0.101 (DNS サーバに与える予定のIPアドレス) になっていること。

- DNS サーバ（named プロセス）へ到達できない
    - ファイアーウォールによって阻まれている可能性があります。次の設定を確認してください。
        - DNS サーバを稼働している AlmaLinux のファイアーウォール (以前のステップで設定済みのはず)
        - (通常問題ないはずですが) Windows 10 のマシンのファイアウォール
        - (通常問題ないはずですが) ネットワーク機器のファイアーウォール

- DNS サーバ（named プロセス）によって遮断されている
    - `/etc/named.conf` の listen-on を確認し、ポート 53、アドレス 192.168.0.101 で待ち受けているかを確認しましょう。
    - `/etc/named.conf` の allow-query を確認し、192.168.0.0/24 (DNS利用者を含むアドレス範囲) が指定されているかを確認しましょう。
